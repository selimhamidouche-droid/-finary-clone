{% extends "base.html" %}
{% load humanize %}

{% block title %}{{ asset.name }} - Marchés{% endblock %}

{% block content %}
<div class="space-y-8 animate-fade-in">
    <!-- Header -->
    <div class="flex items-start justify-between">
        <div>
            <a href="{% url 'portfolio:asset_list' %}"
                class="text-gray-500 hover:text-gold text-sm mb-2 inline-flex items-center gap-1 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                Retour aux marchés
            </a>
            <div class="flex items-center gap-4 mt-2">
                <h1 class="text-4xl font-bold text-gray-900 dark:text-white">{{ asset.name }}</h1>
                <span class="px-3 py-1 rounded-lg text-sm font-medium bg-dark-700 text-gray-300">{{ asset.ticker
                    }}</span>
            </div>
            {% if asset.sector %}
            <p class="text-gray-500 mt-2">{{ asset.sector }}{% if asset.industry %} • {{ asset.industry }}{% endif %}
            </p>
            {% endif %}
        </div>
        <div class="text-right">
            <p class="text-4xl font-bold text-gray-900 dark:text-white font-mono">
                {{ asset.price|floatformat:2 }} <span class="text-lg text-gray-500">{{ asset.currency }}</span>
            </p>
            <p
                class="text-lg font-bold mt-1 {% if asset.change_pct >= 0 %}text-green-500{% else %}text-red-500{% endif %}">
                {% if asset.change_pct >= 0 %}+{% endif %}{{ asset.change_pct }}%
                <span class="text-sm text-gray-500 font-normal">aujourd'hui</span>
            </p>
        </div>
    </div>

    <!-- Chart -->
    {% if asset.chart_data %}
    <div class="bg-white dark:bg-dark-800 rounded-2xl p-6 border border-gray-200 dark:border-gray-800 shadow-xl">
        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Évolution sur 1 mois</h3>
        <div class="h-64">
            <canvas id="priceChart"></canvas>
        </div>
    </div>
    {% endif %}

    <!-- Key Stats Grid -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        {% if asset.open %}
        <div class="bg-white dark:bg-dark-800 rounded-xl p-4 border border-gray-200 dark:border-gray-800">
            <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Ouverture</p>
            <p class="text-xl font-bold text-gray-900 dark:text-white font-mono">{{ asset.open|floatformat:2 }}</p>
        </div>
        {% endif %}

        {% if asset.previous_close %}
        <div class="bg-white dark:bg-dark-800 rounded-xl p-4 border border-gray-200 dark:border-gray-800">
            <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Clôture Précédente</p>
            <p class="text-xl font-bold text-gray-900 dark:text-white font-mono">{{ asset.previous_close|floatformat:2
                }}</p>
        </div>
        {% endif %}

        {% if asset.day_high and asset.day_low %}
        <div class="bg-white dark:bg-dark-800 rounded-xl p-4 border border-gray-200 dark:border-gray-800">
            <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Range du Jour</p>
            <p class="text-xl font-bold text-gray-900 dark:text-white font-mono">{{ asset.day_low|floatformat:2 }} - {{ asset.day_high|floatformat:2  }}</p>
        </div>
        {% endif %}

        {% if asset.week_52_high and asset.week_52_low %}
        <div class="bg-white dark:bg-dark-800 rounded-xl p-4 border border-gray-200 dark:border-gray-800">
            <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">52 Semaines</p>
            <p class="text-xl font-bold text-gray-900 dark:text-white font-mono">{{ asset.week_52_low|floatformat:2 }} -
                {{ asset.week_52_high|floatformat:2 }}</p>
        </div>
        {% endif %}

        {% if asset.volume %}
        <div class="bg-white dark:bg-dark-800 rounded-xl p-4 border border-gray-200 dark:border-gray-800">
            <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Volume</p>
            <p class="text-xl font-bold text-gray-900 dark:text-white font-mono">{{ asset.volume|intcomma }}</p>
        </div>
        {% endif %}

        {% if asset.avg_volume %}
        <div class="bg-white dark:bg-dark-800 rounded-xl p-4 border border-gray-200 dark:border-gray-800">
            <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Volume Moyen</p>
            <p class="text-xl font-bold text-gray-900 dark:text-white font-mono">{{ asset.avg_volume|intcomma }}</p>
        </div>
        {% endif %}

        {% if asset.market_cap %}
        <div class="bg-white dark:bg-dark-800 rounded-xl p-4 border border-gray-200 dark:border-gray-800">
            <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Capitalisation</p>
            <p class="text-xl font-bold text-gray-900 dark:text-white font-mono">
                {% if asset.market_cap >= 1000000000000 %}
                {{ asset.market_cap|floatformat:-12 }}T
                {% elif asset.market_cap >= 1000000000 %}
                {{ asset.market_cap|divisibleby:1000000000|floatformat:1 }}B
                {% else %}
                {{ asset.market_cap|intcomma }}
                {% endif %}
            </p>
        </div>
        {% endif %}

        {% if asset.pe_ratio %}
        <div class="bg-white dark:bg-dark-800 rounded-xl p-4 border border-gray-200 dark:border-gray-800">
            <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">P/E Ratio</p>
            <p class="text-xl font-bold text-gray-900 dark:text-white font-mono">{{ asset.pe_ratio|floatformat:2 }}</p>
        </div>
        {% endif %}

        {% if asset.eps %}
        <div class="bg-white dark:bg-dark-800 rounded-xl p-4 border border-gray-200 dark:border-gray-800">
            <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">EPS</p>
            <p class="text-xl font-bold text-gray-900 dark:text-white font-mono">{{ asset.eps|floatformat:2 }}</p>
        </div>
        {% endif %}

        {% if asset.dividend_yield %}
        <div class="bg-white dark:bg-dark-800 rounded-xl p-4 border border-gray-200 dark:border-gray-800">
            <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Dividende</p>
            <p class="text-xl font-bold text-green-500 font-mono">{{ asset.dividend_yield|floatformat:2 }}%</p>
        </div>
        {% endif %}

        {% if asset.beta %}
        <div class="bg-white dark:bg-dark-800 rounded-xl p-4 border border-gray-200 dark:border-gray-800">
            <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Beta</p>
            <p class="text-xl font-bold text-gray-900 dark:text-white font-mono">{{ asset.beta|floatformat:2 }}</p>
        </div>
        {% endif %}
    </div>

    <!-- Company Info -->
    {% if asset.description or asset.website or asset.employees %}
    <div class="bg-white dark:bg-dark-800 rounded-2xl p-6 border border-gray-200 dark:border-gray-800 shadow-xl">
        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">À propos</h3>

        {% if asset.description %}
        <p class="text-gray-400 text-sm leading-relaxed mb-4">{{ asset.description }}...</p>
        {% endif %}

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 pt-4 border-t border-gray-700">
            {% if asset.country %}
            <div>
                <p class="text-xs text-gray-500 uppercase mb-1">Pays</p>
                <p class="text-gray-900 dark:text-white font-medium">{{ asset.country }}</p>
            </div>
            {% endif %}

            {% if asset.employees %}
            <div>
                <p class="text-xs text-gray-500 uppercase mb-1">Employés</p>
                <p class="text-gray-900 dark:text-white font-medium">{{ asset.employees|intcomma }}</p>
            </div>
            {% endif %}

            {% if asset.website %}
            <div class="col-span-2">
                <p class="text-xs text-gray-500 uppercase mb-1">Site Web</p>
                <a href="{{ asset.website }}" target="_blank"
                    class="text-gold hover:text-yellow-400 transition-colors">{{ asset.website }}</a>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Error message if API failed -->
    {% if asset.error %}
    <div class="bg-red-500/10 border border-red-500/50 text-red-500 p-4 rounded-xl text-sm">
        <p><strong>Erreur API :</strong> {{ asset.error }}</p>
        <p class="mt-2 text-gray-400">Les données affichées peuvent être incomplètes.</p>
    </div>
    {% endif %}
</div>

{% if asset.chart_data %}
<script id="chart-labels" type="application/json">{{ chart_labels|safe }}</script>
<script id="chart-data" type="application/json">{{ chart_data|safe }}</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var ctx = document.getElementById('priceChart').getContext('2d');
        var labels = JSON.parse(document.getElementById('chart-labels').textContent);
        var data = JSON.parse(document.getElementById('chart-data').textContent);

        var gradient = ctx.createLinearGradient(0, 0, 0, 256);
        gradient.addColorStop(0, 'rgba(255, 204, 128, 0.3)');
        gradient.addColorStop(1, 'rgba(255, 204, 128, 0)');

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Prix',
                    data: data,
                    borderColor: '#ffcc80',
                    backgroundColor: gradient,
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0,
                    pointHoverRadius: 6,
                    pointHoverBackgroundColor: '#ffcc80',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#1a1b1e',
                        titleColor: '#fff',
                        bodyColor: '#ffcc80',
                        padding: 12,
                        displayColors: false,
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { color: '#6b7280' }
                    },
                    y: {
                        grid: { color: 'rgba(107, 114, 128, 0.1)' },
                        ticks: { color: '#6b7280' }
                    }
                }
            }
        });
    });
</script>
{% endif %}
{% endblock %}